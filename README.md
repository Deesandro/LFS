# Linux From Scratch Documentation
# Проект по созданию Linux From Scratch (LFS)

## Введение
Создание собственной системы Linux с нуля (Linux From Scratch) — это увлекательный и познавательный процесс, который позволяет глубже понять внутренние механизмы работы операционной системы. Проект LFS представляет собой руководство по сборке полностью настраиваемой версии Linux, которая собирается буквально из исходных кодов, предоставляя вам полный контроль над системой.

### Важность проекта
Создание LFS помогает:
- Получить глубокое понимание процесса загрузки и взаимодействия различных компонентов Linux.
- Научиться работать с основными инструментами, такими как компиляторы и линкеры.
- Улучшить навыки работы с командной строкой и конфигурацией программного обеспечения.

### Применение
LFS может использоваться в образовательных целях, для создания специализированных систем, изучения низкоуровневых аспектов работы Linux, а также для настройки систем под специфические нужды (например, для встраиваемых систем).

## Следующие шаги
На следующем этапе мы будем устанавливать и настраивать виртуальную машину на базе CentOS, которая послужит базой для разработки LFS.

# Проект LFS: Введение

### Аудитория
Проект Linux From Scratch (LFS) ориентирован на тех, кто хочет понять, как работает операционная система Linux на глубоком уровне. Один из частых вопросов: “Почему стоит создавать систему Linux вручную, если можно установить готовый дистрибутив?”

Главная цель проекта — дать полное понимание внутренней работы Linux, продемонстрировать, как все компоненты системы интегрируются и зависят друг от друга. Это позволяет адаптировать систему под конкретные нужды. В отличие от готовых дистрибутивов, LFS позволяет достичь максимального контроля и гибкости, что особенно ценно для разработчиков, инженеров и IT-энтузиастов.

Еще одним преимуществом является возможность создать минималистичную и эффективную систему. Многие дистрибутивы включают ненужные программы, что ведет к избыточному потреблению ресурсов. В LFS можно собрать систему, включающую только те компоненты, которые действительно необходимы. Это особенно полезно для загрузочных дисков, встроенных систем и серверов.

С точки зрения безопасности, LFS предоставляет возможность собрать систему из исходного кода, проверить её и применить исправления, что обеспечивает максимальный контроль и уверенность в безопасности.

Даже если конечная цель не в создании собственной системы, проект LFS помогает глубже понять, как устроен Linux, что делает его полезным для образовательных целей.

### Важность проекта
Проект LFS предоставляет уникальную возможность не только установить и настроить операционную систему, но и глубоко понять её внутреннюю структуру. Он предназначен для тех, кто стремится контролировать каждый аспект своей системы — от базовых библиотек до пользовательских приложений.

LFS позволяет создать систему, которая точно соответствует требованиям пользователя, исключая все ненужные компоненты. Это особенно важно для оптимизации и адаптации системы под конкретные задачи.

### Применение и цели
Проект LFS применяется в различных областях:
- **Образование**: Изучение процесса сборки и настройки операционной системы, понимание её внутренней структуры и компонентов.
- **Оптимизация**: Создание минималистичной системы, адаптированной под специфические нужды, будь то сервер или встроенная система.
- **Исследования**: Эксперименты с различными версиями библиотек и компонентов, что полезно для исследовательских проектов.

Сборка системы с нуля помогает лучше понять её структуру и логику работы, что способствует более осознанному выбору компонентов и поддержке системы.

### Целевые архитектуры LFS
Основные целевые архитектуры LFS — процессоры AMD/Intel x86 (32-разрядные) и x86_64 (64-разрядные). Также LFS может быть адаптирован для работы на процессорах Power PC и ARM с некоторыми изменениями.

### Предварительные требования
Создание LFS — сложная задача, требующая знаний системного администрирования Unix. Необходимо владеть базовыми навыками работы с командной строкой и уметь устанавливать программное обеспечение.

### Стандарты и совместимость
LFS соответствует основным стандартам Linux, таким как POSIX.1-2008, Стандарт иерархии файловой системы (FHS) версии 3.0 и Стандартная база Linux (LSB) версии 5.0. Это обеспечивает совместимость и предсказуемую работу системы.

### Пакеты и их использование
LFS включает необходимые пакеты для создания базовой функциональной системы, а также некоторые дополнительные для удобства и повышения функциональности.

### Типографические соглашения
- Команды и инструкции выделены **моноширинным шрифтом**.
- Важные примечания и пояснения выделены *курсивом*.
- Файлы и пути к ним выделены **моноширинным шрифтом**.

### Структура книги
1. **Введение**: Описание проекта и его целей.
2. **Подготовка к сборке**: Создание разделов, загрузка пакетов и компиляция временных инструментов.
3. **Сборка LFS**: Пошаговые инструкции по сборке и установке всех пакетов.
4. **Приложения**: Дополнительная информация и термины.

### Исправления и безопасность
Редакторы LFS регулярно обновляют информацию об исправлениях и уязвимостях. Рекомендуется проверять актуальные исправления и советы по безопасности на официальном сайте проекта перед началом сборки системы.

# Проект LFS: Введение

### Аудитория

Проект Linux From Scratch (LFS) предназначен для тех, кто хочет глубже понять, как работает Linux. LFS позволяет контролировать каждый аспект системы, адаптировать её под конкретные нужды и создать минималистичную, эффективную систему, что особенно важно для разработчиков и инженеров.

С точки зрения безопасности, LFS позволяет собирать систему из исходного кода, что дает полный контроль над её безопасностью.

### Важность проекта

LFS помогает понять внутреннюю структуру Linux и создать систему, соответствующую конкретным требованиям, исключая ненужные компоненты.

### Применение и цели

- **Образование**: Понимание процесса сборки и настройки ОС.
- **Оптимизация**: Создание минималистичной системы для специфических нужд.
- **Исследования**: Эксперименты с библиотеками и компонентами для исследовательских целей.

### Целевые архитектуры LFS

Основные архитектуры LFS — AMD/Intel x86 и x86\_64. LFS также можно адаптировать для Power PC и ARM.

### Предварительные требования

Создание LFS требует знаний системного администрирования Unix и работы с командной строкой.

### Стандарты и совместимость

LFS соответствует стандартам POSIX.1-2008, FHS 3.0 и LSB 5.0, что обеспечивает совместимость.

### Пакеты и их использование

LFS включает необходимые пакеты для создания базовой функциональной системы и дополнительные для удобства.

### Типографические соглашения

- **Моноширинный шрифт** для команд и файлов.
- *Курсив* для примечаний.

### Структура книги

1. **Введение**: Цели проекта.
2. **Подготовка к сборке**: Создание разделов и временных инструментов.
3. **Сборка LFS**: Пошаговые инструкции.
4. **Приложения**: Дополнительная информация.

### Исправления и безопасность

Проверяйте актуальные исправления и рекомендации по безопасности на официальном сайте LFS.

## 1.1. Как построить систему LFS

LFS создается с использованием существующего дистрибутива Linux (например, Debian или Fedora), который служит отправной точкой для предоставления необходимых инструментов (компилятор, компоновщик, оболочка). При установке выберите опцию «разработка» для включения этих инструментов.

> [Примечание] Настройки по умолчанию дистрибутива могут не подходить для LFS. Рекомендации по настройке см. по адресу: [partitioning-for-lfs.txt](https://www.linuxfromscratch.org/hints/downloads/files/partitioning-for-lfs.txt).

Можно также использовать LiveCD для запуска дистрибутива.

Глава 2 описывает создание раздела и файловой системы для LFS. Глава 3 — загрузку пакетов и исправлений. Глава 4 — настройку рабочей среды. В главе 5 устанавливается начальная цепочка инструментов (binutils, gcc, glibc) для изоляции от хост-системы. Глава 6 описывает кросс-компиляцию базовых утилит, а глава 7 — создание всех остальных инструментов в среде chroot.

Глава 8 завершает сборку системы. Среда chroot позволяет продолжать использовать хост-систему во время сборки. Глава 9 посвящена базовой настройке системы, а глава 10 — ядру и загрузчику. Глава 11 описывает дальнейшие шаги после завершения LFS.

Подробная информация по каждому шагу представлена в следующих главах. Всё станет понятнее по мере выполнения шагов.

## 1.4. Ресурсы

### 1.4.1. Часто задаваемые вопросы

Если у вас возникли ошибки или вопросы при создании LFS, начните с ознакомления со списком часто задаваемых вопросов (FAQ) по адресу: [https://www.linuxfromscratch.org/faq/](https://www.linuxfromscratch.org/faq/).

### 1.4.2. Списки рассылки

На сайте linuxfromscratch.org доступны списки рассылки, используемые для разработки LFS. Если вы не нашли ответа в FAQ, обратитесь к спискам рассылки: [https://www.linuxfromscratch.org/search.html](https://www.linuxfromscratch.org/search.html). Информация о списках рассылки доступна по адресу: [https://www.linuxfromscratch.org/mail.html](https://www.linuxfromscratch.org/mail.html).

### 1.4.3. IRC

Помощь также можно получить через IRC на канале #lfs-support в сети [irc.libera.chat](irc.libera.chat). Убедитесь, что ваш вопрос не покрыт в FAQ или архивах списков рассылки перед обращением.

### 1.4.4. Зеркальные сайты

Проект LFS использует несколько зеркальных сайтов для облегчения доступа к ресурсам. Актуальные зеркала доступны по адресу: [https://www.linuxfromscratch.org/mirrors.html](https://www.linuxfromscratch.org/mirrors.html).

### 1.4.5. Контактная информация

Пожалуйста, направляйте все вопросы и комментарии в один из списков рассылки LFS (см. выше).

## 1.5. Справка

> [Примечание] Если у вас возникла проблема при сборке пакета с помощью инструкции LFS, не отправляйте сообщение о проблеме напрямую на канал поддержки вышестоящей версии, пока не обсудите её на канале поддержки LFS (см. раздел 1.4 «Ресурсы»). Это может быть неэффективно, так как разработчики вышестоящей версии редко знакомы с процедурой сборки LFS. Сообщество LFS может помочь составить правильный отчёт.

### 1.5.1. Что следует упомянуть

В запросе о помощи укажите следующие сведения:

- Версия используемой книги (например, r12.2-22-systemd).
- Дистрибутив хоста и его версия.
- Выходные данные из скрипта требований к хост-системе.
- Пакет или раздел, в котором возникла проблема.
- Точное сообщение об ошибке или описание проблемы.
- Укажите любые отклонения от книги.

> [Примечание] Отклонение от книги не означает, что вам не помогут. Сообщите об изменениях, чтобы мы могли лучше понять проблему.

### 1.5.2. Проблемы с настройкой скрипта

При ошибке во время запуска скрипта `configure` просмотрите файл `config.log`, который может содержать полезные сведения.

### 1.5.3. Проблемы с компиляцией

Для диагностики проблем с компиляцией важны вывод на экран и содержимое файлов. Включите выполненную команду и связанные сообщения об ошибках. Пример вывода, который нужно включить:

```
gcc -D ALIASPATH="/mnt/lfs/usr/share/locale:."
-D LOCALEDIR="/mnt/lfs/usr/share/locale"
-D LIBDIR="/mnt/lfs/usr/lib"
-D INCLUDEDIR="/mnt/lfs/usr/include" -D HAVE_CONFIG_H -I. -I.
-g -O2 -c getopt1.c
gcc -g -O2 -static -o make ar.o arscan.o commands.o dir.o
expand.o file.o function.o getopt.o implicit.o job.o main.o
misc.o read.o remake.o rule.o signame.o variable.o vpath.o
default.o remote-stub.o version.o opt1.o
-lutil job.o: In function `load_too_high':
/lfs/tmp/make-3.79.1/job.c:1565: undefined reference
to `getloadavg'
collect2: ld returned 1 exit status
make[2]: *** [make] Error 1
```

Включите всю информацию, а не только финальную ошибку.

Рекомендуется прочитать статью о том, как обращаться за помощью в интернете: [http://catb.org/\~esr/faqs/smart-questions.html](http://catb.org/~esr/faqs/smart-questions.html).

## 1.6. Предварительная настройка системы перед установкой CentOS на виртуальную машину

### 1.6.1. Включение суперпользователя (root)

1. После загрузки установочного образа CentOS выберите опцию для начала установки.
2. На экране «Настройка безопасности» убедитесь, что пользователь root включён и задан надёжный пароль. Это позволит вам получить полный контроль над системой для её дальнейшей настройки.

### 1.6.2. Разметка диска

1. На этапе разметки диска выберите «Ручная разметка» (Custom).
2. Создайте следующие разделы:
   - **Раздел `/boot`**:
     - Размер: 500 МБ - 1 ГБ.
     - Файловая система: ext4.
     - Тип устройства: **Стандартный раздел**.
     - Назначение: хранение загрузочных файлов, необходимых для загрузки системы.
   - **Корневой раздел (`/`)**:
     - Размер: 20-30 ГБ.
     - Файловая система: ext4.
     - Тип устройства: **Стандартный раздел**.
   - **Раздел `/home`**:
     - Размер: 10-20 ГБ (в зависимости от потребностей пользователей).
     - Файловая система: ext4.
     - Тип устройства: **LVM** (рекомендуется для гибкости управления).
   - **Раздел `/var`**:
     - Размер: 10-15 ГБ.
     - Файловая система: ext4.
     - Тип устройства: **LVM** (рекомендуется для логов и временных файлов).
     - Назначение: хранение логов и временных файлов.
   - **Раздел `/swap`**:
     - Размер: равен или вдвое превышает объём ОЗУ.
     - Файловая система: swap.
     - Тип устройства: **Динамический LVM** (для гибкости управления памятью).
     - Назначение: поддержка виртуальной памяти.
   - **Раздел для LFS (`/mnt/lfs`)**:
     - Размер: 30-50 ГБ.
     - Файловая система: ext4.
     - Тип устройства: **Стандартный раздел**.
     - Назначение: раздел для установки и настройки LFS.
3. Убедитесь, что все разделы имеют подходящий файловый формат (например, ext4 для файловых разделов и swap для раздела подкачки).
4. Примените изменения и подтвердите разметку.

### 1.6.3. Выбор программ

1. На этапе выбора программ выберите тип установки: **Минимальная установка** или **С установкой для разработки**.
2. Включите следующие компоненты:
   - **Development Tools** (инструменты для разработки): включает компиляторы, отладчики, библиотеки и другие утилиты для создания программного обеспечения.
   - **Console Internet Tools** (консольные сетевые инструменты): инструменты для работы с сетью, такие как `wget` и `curl` для загрузки исходных кодов и пакетов.
   - **System Tools** (системные утилиты): инструменты для работы с системой, необходимые для базовой настройки и управления.
3. Убедитесь, что установлены все необходимые зависимости для дальнейшей сборки LFS.

### 1.6.4. Включение kdump

1. Включите `kdump` на этапе настройки, чтобы обеспечить создание дампов памяти в случае критической ошибки ядра.
2. Убедитесь, что выделено достаточно памяти для работы `kdump` (обычно не менее 128 МБ).

### 1.6.5. Сетевые настройки

1. Убедитесь, что настроены базовые сетевые параметры (IP-адрес, маска сети, шлюз и DNS).
2. Это позволит вам загружать необходимые пакеты и исправления во время установки и настройки LFS.

### 1.6.6. Проверка настроек

1. Перед началом установки проверьте все настройки, включая разделы, выбор программ и параметры безопасности.
2. Убедитесь, что все критически важные параметры настроены правильно, чтобы избежать проблем в будущем.

После выполнения этих шагов можно начинать установку CentOS, которая послужит базой для дальнейшего создания LFS.

## 2.2. Требования к хост-системе

### 2.2.1. Аппаратное обеспечение

Редакторы LFS рекомендуют, чтобы процессор системы имел не менее четырёх ядер, а объём памяти составлял не менее 8 ГБ. Более старые системы, не соответствующие этим требованиям, всё равно будут работать, но время создания пакетов будет значительно больше, чем указано в документации.

### 2.2.2. Программное обеспечение

В вашей хост-системе должно быть следующее программное обеспечение с указанными минимальными версиями. Это не должно быть проблемой для большинства современных дистрибутивов Linux. Также обратите внимание, что многие дистрибутивы помещают заголовки программного обеспечения в отдельные пакеты, часто в форме <package-name>-devel или <package-name>-dev. Обязательно установите их, если они предусмотрены в вашем дистрибутиве.

Более ранние версии перечисленных программных пакетов могут работать, но не были протестированы.

- **Bash-3.2** (/bin/sh должна быть символической или жёсткой ссылкой на bash)
- **Binutils-2.13.1** (версии выше 2.43.1 не рекомендуются, так как они не были протестированы)
- **Bison-2.7** (/usr/bin/yacc должен быть ссылкой на bison или небольшим скриптом, выполняющим bison)
- **Coreutils-8.1**
- **Diffutils-2.8.1**
- **Findutils-4.2.31**
- **Gawk-4.0.1** (/usr/bin/awk должен быть ссылкой на gawk)
- **GCC-5.2**, включая компилятор C++, g++ (версии выше 14.2.0 не рекомендуются, так как они не были протестированы). Также должны присутствовать стандартные библиотеки C и C++ (с заголовками), чтобы компилятор C++ мог создавать размещённые программы
- **Grep-2.5.1a**
- **Gzip-1.3.12**
- **Ядро Linux-4.19**
  - Причина, по которой требуется определённая версия ядра, заключается в том, что мы указываем эту версию при сборке glibc в главах 5 и 8, поэтому обходные пути для более старых версий ядра не используются, а скомпилированная glibc работает немного быстрее и занимает меньше места. По состоянию на февраль 2024 года 4.19 — это самая старая версия ядра, которая всё ещё поддерживается разработчиками. Некоторые версии ядра старше 4.19 могут по-прежнему поддерживаться сторонними командами, но они не считаются официальными версиями ядра; подробности см. на [kernel.org](https://kernel.org/category/releases.html).
  - Если версия ядра хоста ниже 4.19, вам потребуется заменить ядро на более современную версию. Это можно сделать двумя способами. Во-первых, проверьте, предоставляет ли ваш поставщик Linux пакет ядра версии 4.19 или выше. Если да, вы можете установить его. Если ваш поставщик не предлагает подходящий пакет ядра или вы предпочитаете не устанавливать его, вы можете скомпилировать ядро самостоятельно. Инструкции по компиляции ядра и настройке загрузчика (при условии, что хост использует GRUB) приведены в главе 10.
  - Нам требуется, чтобы ядро хоста поддерживало псевдотерминал UNIX 98 (PTY). Он должен быть включен во всех дистрибутивах Linux 4.19 или более новых версиях для настольных компьютеров и серверов. Если вы создаете собственное ядро хоста, убедитесь, что CONFIG_UNIX98_PTYS установлено на y в конфигурации ядра.
- **M4-1.4.10**
- **Make-4.0**
- **Patch-2.5.4**
- **Perl-5.8.8**
- **Python-3.4**
- **Sed-4.1.5**
- **Tar-1.22**
- **Texinfo-5.0**
- **Xz-5.0.0**

> [Важно] Обратите внимание, что для создания системы LFS с помощью инструкций, содержащихся в этой книге, требуются символические ссылки, упомянутые выше. Символические ссылки, указывающие на другое программное обеспечение (например, dash, mawk и т. д.), могут работать, но не тестируются и не поддерживаются командой разработчиков LFS и могут потребовать либо отклонения от инструкций, либо дополнительных исправлений для некоторых пакетов.

Чтобы узнать, есть ли в вашей системе все необходимые версии и возможность компилировать программы, выполните следующие команды:

```bash
cat > version-check.sh << "EOF"
#!/bin/bash
# A script to list version numbers of critical development tools

# If you have tools installed in other directories, adjust PATH here AND
# in ~lfs/.bashrc (section 4.4) as well.

LC_ALL=C 
PATH=/usr/bin:/bin

bail() { echo "FATAL: $1"; exit 1; }
grep --version > /dev/null 2> /dev/null || bail "grep does not work"
sed '' /dev/null || bail "sed does not work"
sort   /dev/null || bail "sort does not work"

ver_check()
{
   if ! type -p $2 &>/dev/null
   then 
     echo "ERROR: Cannot find $2 ($1)"; return 1; 
   fi
   v=$($2 --version 2>&1 | grep -E -o '[0-9]+\.[0-9\.]+[a-z]*' | head -n1)
   if printf '%s
' $3 $v | sort --version-sort --check &>/dev/null
   then 
     printf "OK:    %-9s %-6s >= $3
" "$1" "$v"; return 0;
   else 
     printf "ERROR: %-9s is TOO OLD ($3 or later required)
" "$1"; 
     return 1; 
   fi
}

ver_kernel()
{
   kver=$(uname -r | grep -E -o '^[0-9\.]+')
   if printf '%s
' $1 $kver | sort --version-sort --check &>/dev/null
   then 
     printf "OK:    Linux Kernel $kver >= $1
"; return 0;
   else 
     printf "ERROR: Linux Kernel ($kver) is TOO OLD ($1 or later required)
" "$kver"; 
     return 1; 
   fi
}

# Coreutils first because --version-sort needs Coreutils >= 7.0
ver_check Coreutils      sort     8.1 || bail "Coreutils too old, stop"
ver_check Bash           bash     3.2
ver_check Binutils       ld       2.13.1
ver_check Bison          bison    2.7
ver_check Diffutils      diff     2.8.1
ver_check Findutils      find     4.2.31
ver_check Gawk           gawk     4.0.1
ver_check GCC            gcc      5.2
ver_check "GCC (C++)"    g++      5.2
ver_check Grep           grep     2.5.1a
ver_check Gzip           gzip     1.3.12
ver_check M4             m4       1.4.10
ver_check Make           make     4.0
ver_check Patch          patch    2.5.4
ver_check Perl           perl     5.8.8
ver_check Python         python3  3.4
ver_check Sed            sed      4.1.5
ver_check Tar            tar      1.22
ver_check Texinfo        texi2any 5.0
ver_check Xz             xz       5.0.0
ver_kernel 4.19

if mount | grep -q 'devpts on /dev/pts' && [ -e /dev/ptmx ]
then echo "OK:    Linux Kernel supports UNIX 98 PTY";
else echo "ERROR: Linux Kernel does NOT support UNIX 98 PTY"; fi

alias_check() {
   if $1 --version 2>&1 | grep -qi $2
   then printf "OK:    %-4s is $2
" "$1";
   else printf "ERROR: %-4s is NOT $2
" "$1"; fi
}
echo "Aliases:"
alias_check awk GNU
alias_check yacc Bison
alias_check sh Bash

echo "Compiler check:"
if printf "int main(){}" | g++ -x c++ -
then echo "OK:    g++ works";
else echo "ERROR: g++ does NOT work"; fi
rm -f a.out

if [ "$(nproc)" = "" ]; then
   echo "ERROR: nproc is not available or it produces empty output"
else
   echo "OK: nproc reports $(nproc) logical cores are available"
fi
EOF

bash version-check.sh